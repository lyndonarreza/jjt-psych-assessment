{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ current_exam.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/exam_style.css' %}">
</head>
<body>
<div class="container mt-5 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold">{{ current_exam.title }}</h3>
    {% if current_exam.time_limit_minutes|default:0 > 0 %}
      <div class="timer badge bg-danger p-2" id="timer">00:00</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <span>Exam {{ exam_index }} of {{ total_exams }}</span> |
    <span>Time Limit: {{ current_exam.time_limit_minutes }} min</span> |
    <span>Total Questions: {{ questions|length }}</span>
    <div class="progress mt-2">
      <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percent }}%;">
        {{ progress_percent }}%
      </div>
    </div>
  </div>

  {% if warning %}
    <div class="alert alert-danger mb-3">{{ warning }}</div>
  {% endif %}
  <p class="text-danger fw-bold" id="unanswered-warning" style="display:none;"></p>

  <form method="post" id="exam-form">
    {% csrf_token %}
    {% for question in questions %}
      <div class="card mb-4 shadow-sm question-box">
        <div class="card-body">
          <p class="fw-semibold mb-3">{{ forloop.counter }}. {{ question.text }}</p>

          {# ───────────── Likert (Horizontal) ───────────── #}

        {% if question.qtype == "likertquestion" %}
          <div class="likert-row" role="group" aria-label="Likert options for question {{ forloop.counter }}">
            {% for val, label in likert_choices %}
              <label class="likert-option">
                <input
                  class="form-check-input"
                  type="radio"
                  name="q_{{ question.id }}"
                  value="{{ val }}"
                  onchange="saveAnswerToLocalStorage({{ question.id }}, '{{ val|escapejs }}')"
                  {% if request.session|get_item:"answer_"|add:question.id|stringformat:"s" == val %}checked{% endif %}>
                <span class="likert-text">{{ label }}</span>
              </label>
            {% endfor %}
          </div>


         

          {# ───────────── MCQ ───────────── #}
          {% elif question.qtype == "mcqquestion" %}
            {% for choice in question.choices.all %}
              <div class="form-check mb-1">
                <input
                  class="form-check-input"
                  id="q{{ question.id }}_c{{ forloop.counter }}"
                  type="radio"
                  name="q_{{ question.id }}"
                  value="{{ choice.id }}"
                  onchange="saveAnswerToLocalStorage({{ question.id }}, '{{ choice.id }}')"
                  {% if request.session|get_item:"answer_"|add:question.id|stringformat:"s" == choice.id|stringformat:"s" %}checked{% endif %}
                >
                <label class="form-check-label" for="q{{ question.id }}_c{{ forloop.counter }}">{{ choice.choice_text }}</label>
              </div>
            {% endfor %}

          {# ───────────── True / False ───────────── #}
          {% elif question.qtype == "truefalsequestion" %}
            <div class="form-check mb-1">
              <input
                class="form-check-input"
                id="q{{ question.id }}_true"
                type="radio"
                name="q_{{ question.id }}"
                value="True"
                onchange="saveAnswerToLocalStorage({{ question.id }}, 'True')"
                {% if request.session|get_item:"answer_"|add:question.id|stringformat:"s" == "True" %}checked{% endif %}
              >
              <label class="form-check-label" for="q{{ question.id }}_true">True</label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                id="q{{ question.id }}_false"
                type="radio"
                name="q_{{ question.id }}"
                value="False"
                onchange="saveAnswerToLocalStorage({{ question.id }}, 'False')"
                {% if request.session|get_item:"answer_"|add:question.id|stringformat:"s" == "False" %}checked{% endif %}
              >
              <label class="form-check-label" for="q{{ question.id }}_false">False</label>
            </div>

          {# ───────────── Essay ───────────── #}
          {% elif question.qtype == "essayquestion" %}
            <label class="form-label" for="q_{{ question.id }}">Essay Answer</label>
            <textarea
              class="form-control"
              id="q_{{ question.id }}"
              name="q_{{ question.id }}"
              rows="4"
              placeholder="Type your answer..."
              oninput="autoSaveEssay({{ question.id }})"
            >{{ request.session|get_item:"answer_"|add:question.id|stringformat:"s" }}</textarea>
          {% endif %}
        </div>
      </div>
    {% endfor %}

    <button type="submit" class="btn btn-primary w-100">
      {% if has_next %}Next Exam{% else %}Submit{% endif %}
    </button>
  </form>
</div>

<script>
  // --- Timer (only if > 0 minutes) ---
  (function(){
    const minutesCfg = Number('{{ current_exam.time_limit_minutes|default:0 }}');
    const hasTimer = minutesCfg > 0;
    if (!hasTimer) return;

    let timeLeft = minutesCfg * 60;
    const timerEl = document.getElementById('timer');
    const form = document.getElementById('exam-form');

    const tick = setInterval(() => {
      const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const s = String(timeLeft % 60).padStart(2, '0');
      if (timerEl) timerEl.textContent = `${m}:${s}`;

      if (timeLeft <= 0) {
        clearInterval(tick);
        const warn = document.getElementById('unanswered-warning');
        if (warn) {
          warn.textContent = "Time is up! Auto-submitting your answers.";
          warn.style.display = "block";
        }
        highlightUnanswered();
        autoSaveEssays();
        setTimeout(() => {
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'auto_submit';
          hidden.value = '1';
          form.appendChild(hidden);
          form.submit();
        }, 2000);
      }
      timeLeft--;
    }, 1000);
  })();

  // --- Highlight unanswered (for warning state) ---
  function highlightUnanswered() {
    // radios
    const radios = document.querySelectorAll('input[type="radio"]');
    const byName = {};
    radios.forEach(r => {
      byName[r.name] = byName[r.name] || [];
      byName[r.name].push(r);
    });
    Object.keys(byName).forEach(name => {
      const group = byName[name];
      const anyChecked = group.some(r => r.checked);
      if (!anyChecked) {
        const box = group[0].closest('.question-box');
        if (box) box.classList.add('unanswered');
      }
    });

    // essays
    document.querySelectorAll('textarea').forEach(t => {
      if (!t.value.trim()) {
        t.classList.add('unanswered-textarea');
        const box = t.closest('.question-box');
        if (box) box.classList.add('unanswered');
      }
    });

    const first = document.querySelector('.unanswered');
    if (first) first.scrollIntoView({ behavior: 'smooth' });
  }

  // --- Save helpers (GLOBAL so inline handlers can call them) ---
  window.saveAnswerToLocalStorage = function(qid, value) {
    try {
      localStorage.setItem('answer_' + qid, String(value));
      // Optional: also mirror to session via existing endpoint
      fetch("{% url 'save_essay_answer' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ question_id: qid, answer: String(value) })
      }).catch(()=>{});
    } catch (e) {
      console.error('saveAnswerToLocalStorage failed:', e);
    }
  };

  function autoSaveEssay(qid) {
    const ta = document.querySelector(`textarea[name="q_${qid}"]`);
    if (!ta) return;
    const val = ta.value;
    localStorage.setItem('answer_' + qid, val);
    fetch("{% url 'save_essay_answer' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ question_id: qid, answer: val })
    }).catch(()=>{});
  }

  function autoSaveEssays() {
    document.querySelectorAll('textarea').forEach(ta => {
      const qid = (ta.name.split('_')[1] || '').trim();
      if (!qid) return;
      const val = ta.value;
      localStorage.setItem('answer_' + qid, val);
      fetch("{% url 'save_essay_answer' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ question_id: qid, answer: val })
      }).catch(()=>{});
    });
  }

  // --- Restore answers from localStorage on load (works for radios & essays) ---
  document.addEventListener('DOMContentLoaded', () => {
    // Radios
    document.querySelectorAll('input[type="radio"]').forEach(r => {
      const qid = (r.name.split('_')[1] || '').trim();
      const saved = localStorage.getItem('answer_' + qid);
      if (saved != null && saved !== '') {
        if (r.value == saved) r.checked = true;
      }
    });
    // Essays
    document.querySelectorAll('textarea').forEach(ta => {
      const qid = (ta.name.split('_')[1] || '').trim();
      const saved = localStorage.getItem('answer_' + qid);
      if (saved != null) ta.value = saved;
    });

    {% if warning %}
      // If server asked to warn, show unanswered marks
      highlightUnanswered();
    {% endif %}
  });
</script>
</body>
</html>
