{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ current_exam.title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/exam_style.css' %}">
</head>
<body>
<div class="container mt-5 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold">{{ current_exam.title }}</h3>
    {% if current_exam.time_limit_minutes > 0 %}
      <div class="timer badge bg-danger p-2" id="timer">00:00</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <span>Exam {{ exam_index }} of {{ total_exams }}</span> |
    <span>Time Limit: {{ current_exam.time_limit_minutes }} min</span> |
    <span>Total Questions: {{ questions|length }}</span>
    <div class="progress mt-2">
      <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percent }}%;">
        {{ progress_percent }}%
      </div>
    </div>
  </div>

  {% if warning %}
    <div class="alert alert-danger">{{ warning }}</div>
  {% endif %}

  <p class="text-danger fw-bold" id="unanswered-warning" style="display:none;"></p>

  <form method="post" id="exam-form">
    {% csrf_token %}
    {% for question in questions %}
      <div class="card mb-4 shadow-sm question-box">
        <div class="card-body">
          <p class="fw-semibold">{{ forloop.counter }}. {{ question.text }}</p>

          {# Likert Question #}
          {% if question.qtype == "likertquestion" %}
            <div class="likert-horizontal">
              {% for val, label in likert_choices %}
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="q_{{ question.id }}" value="{{ val }}"
                    id="q_{{ question.id }}_{{ forloop.counter }}"
                    onchange="saveAnswerToLocalStorage({{ question.id }}, '{{ val }}')">
                  <label class="form-check-label" for="q_{{ question.id }}_{{ forloop.counter }}">{{ label }}</label>
                </div>
              {% endfor %}
            </div>
            
            <script>
              const likertSaved_{{ question.id }} = localStorage.getItem("answer_{{ question.id }}");
              if (likertSaved_{{ question.id }}) {
                const likertRadio = document.querySelector(`input[name='q_{{ question.id }}'][value='${likertSaved_{{ question.id }}}']`);
                if (likertRadio) likertRadio.checked = true;
              }
            </script>

          {# MCQ Question #}
          {% elif question.qtype == "mcqquestion" %}
            {% for choice in question.choices.all %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q_{{ question.id }}" value="{{ choice.id }}"
                  id="q_{{ question.id }}_{{ forloop.counter }}"
                  onchange="saveAnswerToLocalStorage({{ question.id }}, '{{ choice.id }}')">
                <label class="form-check-label" for="q_{{ question.id }}_{{ forloop.counter }}">{{ choice.choice_text }}</label>
              </div>
            {% endfor %}
            <script>
              const mcqSaved_{{ question.id }} = localStorage.getItem("answer_{{ question.id }}");
              if (mcqSaved_{{ question.id }}) {
                const mcqRadio = document.querySelector(`input[name='q_{{ question.id }}'][value='${mcqSaved_{{ question.id }}}']`);
                if (mcqRadio) mcqRadio.checked = true;
              }
            </script>

          {# True/False Question #}
          {% elif question.qtype == "truefalsequestion" %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="q_{{ question.id }}" value="True"
                id="q_{{ question.id }}_true"
                onchange="saveAnswerToLocalStorage({{ question.id }}, 'True')">
              <label class="form-check-label" for="q_{{ question.id }}_true">True</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="q_{{ question.id }}" value="False"
                id="q_{{ question.id }}_false"
                onchange="saveAnswerToLocalStorage({{ question.id }}, 'False')">
              <label class="form-check-label" for="q_{{ question.id }}_false">False</label>
            </div>
            <script>
              const tfSaved_{{ question.id }} = localStorage.getItem("answer_{{ question.id }}");
              if (tfSaved_{{ question.id }}) {
                const tfRadio = document.querySelector(`input[name='q_{{ question.id }}'][value='${tfSaved_{{ question.id }}}']`);
                if (tfRadio) tfRadio.checked = true;
              }
            </script>

          {# Essay Question #}
          {% elif question.qtype == "essayquestion" %}
            <label for="q_{{ question.id }}">Essay Answer:</label>
            <textarea name="q_{{ question.id }}" id="q_{{ question.id }}" rows="4" class="form-control"
              placeholder="Type your answer..." oninput="autoSaveEssay({{ question.id }})"></textarea>
            <script>
              const restoredEssay_{{ question.id }} = localStorage.getItem("answer_{{ question.id }}") || `{{ request.session|get_item:"answer_"|add:question.id|stringformat:"s" }}`;
              if (restoredEssay_{{ question.id }}) document.getElementById("q_{{ question.id }}").value = restoredEssay_{{ question.id }};
            </script>
          {% endif %}
        </div>
      </div>
    {% endfor %}

    <button type="submit" class="btn btn-primary w-100">
      {% if has_next %}Next Exam{% else %}Submit{% endif %}
    </button>
  </form>
</div>

<script>
function saveAnswerToLocalStorage(qid, value) {
  localStorage.setItem("answer_" + qid, value);
}

function autoSaveEssay(questionId) {
  const textarea = document.querySelector(`textarea[name="q_${questionId}"]`);
  localStorage.setItem("answer_" + questionId, textarea.value);
  fetch("{% url 'save_essay_answer' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({
      question_id: questionId,
      answer: textarea.value
    })
  });
}

let timeLeft = {{ current_exam.time_limit_minutes|default:2 }};
timeLeft = timeLeft > 0 ? timeLeft * 60 : null;

function startTimer() {
  if (timeLeft === null) return;
  const timerEl = document.getElementById("timer");
  const form = document.getElementById("exam-form");

  const countdown = setInterval(() => {
    const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    const seconds = String(timeLeft % 60).padStart(2, '0');
    if (timerEl) timerEl.textContent = `${minutes}:${seconds}`;

    if (timeLeft <= 0) {
      clearInterval(countdown);
      document.getElementById("unanswered-warning").innerText = "Time is up! Auto-submitting your answers.";
      document.getElementById("unanswered-warning").style.display = "block";
      setTimeout(() => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'auto_submit';
        input.value = '1';
        form.appendChild(input);
        form.submit();
      }, 3000);
    }
    timeLeft--;
  }, 1000);
}

startTimer();
</script>
</body>
</html>
