{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ current_exam.title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/exam_style.css' %}">
</head>
<body>
<div class="container mt-5 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold">{{ current_exam.title }}</h3>
    {% if current_exam.time_limit_minutes > 0 %}
      <div class="timer badge bg-danger p-2" id="timer">00:00</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <span>Exam {{ exam_index }} of {{ total_exams }}</span> |
    <span>Time Limit: {{ current_exam.time_limit_minutes }} min</span> |
    <span>Total Questions: {{ questions|length }}</span>
    <div class="progress mt-2">
      <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percent }}%;">
        {{ progress_percent }}%
      </div>
    </div>
  </div>

  {% if warning %}
    <div class="alert alert-danger">{{ warning }}</div>
  {% endif %}

  <p class="text-danger fw-bold" id="unanswered-warning" style="display:none;"></p>

  <form method="post" id="exam-form">
    {% csrf_token %}
    {% for question in questions %}
      <div class="card mb-4 shadow-sm question-box">
        <div class="card-body">
          <p class="fw-semibold">{{ forloop.counter }}. {{ question.text }}</p>

          {# Likert Question #}


          {% if question.qtype == "likertquestion" %}
            <fieldset class="likert-group">
              <legend class="visually-hidden">Likert for question {{ forloop.counter }}</legend>

              
            <div class="likert-horizontal">
              {% for val, label in likert_choices %}
                <label class="{% if unanswered %}unanswered{% endif %}">
                  <input
                    type="radio"
                    name="q_{{ question.id }}"
                    value="{{ val }}"
                    class="likert-radio"
                    onchange="saveAnswerToLocalStorage({{ question.id }}, '{{ val }}')"
                    {% if request.session|get_item:"answer_"|add:question.id|stringformat:"s" == val %}checked{% endif %}>
                  <span class="likert-text">{{ label }}</span>
                </label>
              {% endfor %}
            </div>
            <script>
              (function(){
                const saved = localStorage.getItem("answer_{{ question.id }}");
                if (saved) {
                  const r = document.querySelector(`input[name='q_{{ question.id }}'][value='${saved}']`);
                  if (r) r.checked = true;
                }
              })();
            </script>


            {# Short Answer Question #}
            {% elif question.qtype == "shortanswerquestion" %}
              <div class="form-group">
                <label for="q_{{ question.id }}">Your Answer:</label>
                <input type="text" name="q_{{ question.id }}" id="q_{{ question.id }}" class="form-control"
                  placeholder="Type your answer..." oninput="saveAnswerToLocalStorage({{ question.id }}, this.value)">
              </div>
              <script>
                const shortAnswerSaved_{{ question.id }} = localStorage.getItem("answer_{{ question.id }}");
                if (shortAnswerSaved_{{ question.id }}) {
                  document.getElementById("q_{{ question.id }}").value = shortAnswerSaved_{{ question.id }};
                }
              </script>


          {# MCQ Question #}
          {% elif question.qtype == "mcqquestion" %}
            {% for choice in question.choices.all %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q_{{ question.id }}" value="{{ choice.id }}"
                  id="q_{{ question.id }}_{{ forloop.counter }}"
                  onchange="saveAnswerToLocalStorage({{ question.id }}, '{{ choice.id }}')">
                <label class="form-check-label" for="q_{{ question.id }}_{{ forloop.counter }}">{{ choice.choice_text }}</label>
              </div>
            {% endfor %}
            <script>
              const mcqSaved_{{ question.id }} = localStorage.getItem("answer_{{ question.id }}");
              if (mcqSaved_{{ question.id }}) {
                const mcqRadio = document.querySelector(`input[name='q_{{ question.id }}'][value='${mcqSaved_{{ question.id }}}']`);
                if (mcqRadio) mcqRadio.checked = true;
              }
            </script>

          {# True/False Question #}
          {% elif question.qtype == "truefalsequestion" %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="q_{{ question.id }}" value="True"
                id="q_{{ question.id }}_true"
                onchange="saveAnswerToLocalStorage({{ question.id }}, 'True')">
              <label class="form-check-label" for="q_{{ question.id }}_true">True</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="q_{{ question.id }}" value="False"
                id="q_{{ question.id }}_false"
                onchange="saveAnswerToLocalStorage({{ question.id }}, 'False')">
              <label class="form-check-label" for="q_{{ question.id }}_false">False</label>
            </div>
            <script>
              const tfSaved_{{ question.id }} = localStorage.getItem("answer_{{ question.id }}");
              if (tfSaved_{{ question.id }}) {
                const tfRadio = document.querySelector(`input[name='q_{{ question.id }}'][value='${tfSaved_{{ question.id }}}']`);
                if (tfRadio) tfRadio.checked = true;
              }
            </script>

          {# Essay Question #}
          {% elif question.qtype == "essayquestion" %}
            <label for="q_{{ question.id }}">Essay Answer:</label>
            <textarea name="q_{{ question.id }}" id="q_{{ question.id }}" rows="4" class="form-control"
              placeholder="Type your answer..." oninput="autoSaveEssay({{ question.id }})"></textarea>
            <script>
              const restoredEssay_{{ question.id }} = localStorage.getItem("answer_{{ question.id }}") || `{{ request.session|get_item:"answer_"|add:question.id|stringformat:"s" }}`;
              if (restoredEssay_{{ question.id }}) document.getElementById("q_{{ question.id }}").value = restoredEssay_{{ question.id }};
            </script>
          {% endif %}
        </div>
      </div>
    {% endfor %}

    <button type="submit" class="btn btn-primary w-100">
      {% if has_next %}Next Exam{% else %}Submit{% endif %}
    </button>
  </form>
</div>

<script>
function saveAnswerToLocalStorage(qid, value) {
  localStorage.setItem("answer_" + qid, value);
}

function autoSaveEssay(questionId) {
  const textarea = document.querySelector(`textarea[name="q_${questionId}"]`);
  localStorage.setItem("answer_" + questionId, textarea.value);
  fetch("{% url 'save_essay_answer' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({
      question_id: questionId,
      answer: textarea.value
    })
  });
}

function highlightUnanswered() {
  // clear previous flags
  document.querySelectorAll('.question-box').forEach(b => b.classList.remove('unanswered'));

  // radio groups (MCQ/TF/Likert)
  const radioGroups = [...new Set([...document.querySelectorAll('input[type=radio]')].map(r => r.name))];
  radioGroups.forEach(name => {
    const group = document.getElementsByName(name);
    const answered = [...group].some(r => r.checked);
    if (!answered && group.length) {
      group[0].closest('.question-box').classList.add('unanswered');
    }
  });

   // essays
  document.querySelectorAll('textarea').forEach(t => {
    if (!t.value.trim()) {
      t.closest('.question-box').classList.add('unanswered');
      t.classList.add('unanswered-textarea');
    } else {
      t.classList.remove('unanswered-textarea');
    }
  });

  const first = document.querySelector('.unanswered');
  const banner = document.getElementById('unanswered-warning');

  if (first) {
    banner.textContent = 'You have unanswered questions. Please complete them before continuing.';
    banner.style.display = 'block';
    first.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return true; // has unanswered
  } else {
    banner.style.display = 'none';
    return false;
  }
}


// Block submit if anything is missing
document.getElementById('exam-form').addEventListener('submit', (e) => {
  if (highlightUnanswered()) e.preventDefault();
});

// Clear red state as the user answers
document.addEventListener('change', (e) => {
  if (e.target.matches('input[type=radio]') || e.target.matches('textarea')) {
    const box = e.target.closest('.question-box');
    box?.classList.remove('unanswered');
    if (!highlightUnanswered()) {
      document.getElementById('unanswered-warning').style.display = 'none';
    }
  }
});



let timeLeft = {{ current_exam.time_limit_minutes|default:2 }};
timeLeft = timeLeft > 0 ? timeLeft * 60 : null;

function startTimer() {
  if (timeLeft === null) return;
  const timerEl = document.getElementById("timer");
  const form = document.getElementById("exam-form");

  const countdown = setInterval(() => {
    const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    const seconds = String(timeLeft % 60).padStart(2, '0');
    if (timerEl) timerEl.textContent = `${minutes}:${seconds}`;

    if (timeLeft <= 0) {
      clearInterval(countdown);
      document.getElementById("unanswered-warning").innerText = "Time is up! Auto-submitting your answers.";
      document.getElementById("unanswered-warning").style.display = "block";
      setTimeout(() => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'auto_submit';
        input.value = '1';
        form.appendChild(input);
        form.submit();
      }, 3000);
    }
    timeLeft--;
  }, 1000);
}

startTimer();
</script>
</body>
</html>
